name: SQL Linting and Formatting

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.sql'
      - '.github/workflows/sql-lint.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.sql'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install SQL linting tools
        run: |
          pip install --upgrade pip
          pip install sqlfluff
      
      - name: Get changed SQL files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For pull requests, get files changed compared to base branch
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB origin/${{ github.base_ref }}...HEAD -- '*.sql' | tr '\n' ' ')
          else
            # For push events, get files changed in the last commit
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB HEAD~1 HEAD -- '*.sql' | tr '\n' ' ')
          fi
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed SQL files: $CHANGED_FILES"
      
      - name: Auto-format changed SQL files with sqlfluff
        if: steps.changed-files.outputs.files != ''
        continue-on-error: true
        run: |
          sqlfluff fix --dialect oracle ${{ steps.changed-files.outputs.files }} \
            --rules L001,L002,L003,L004,L005,L006,L007,L008,L010,L011,L012,L013,L014,L015,L016,L017,L018,L019,L020,L021,L022,L023,L024,L025,L026,L027,L028,L029,L030,L031,L032,L033,L034,L035,L036,L037,L038,L039,L040,L041,L042,L043,L044,L045,L046,L047,L048,L049,L050,L051,L052,L053,L054,L055,L056,L057,L058,L059,L060 \
            --force
      
      - name: Check for changes
        id: verify-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure Git user
        if: steps.verify-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Commit auto-formatted SQL files
        if: steps.verify-changes.outputs.has_changes == 'true'
        run: |
          git add '*.sql'
          git commit -m "chore: auto-format SQL files with sqlfluff"
      
      - name: Push formatted changes
        if: steps.verify-changes.outputs.has_changes == 'true'
        run: |
          git push origin HEAD:${{ github.ref_name }} --force-with-lease
      
      - name: Verify linting after fixes
        if: steps.changed-files.outputs.files != ''
        continue-on-error: true
        run: |
          sqlfluff lint --dialect oracle ${{ steps.changed-files.outputs.files }} --format human
      
      - name: Generate JSON lint report
        if: always() && steps.changed-files.outputs.files != ''
        continue-on-error: true
        run: |
          sqlfluff lint --dialect oracle ${{ steps.changed-files.outputs.files }} --format json > lint-report.json
      
      - name: Upload lint report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sql-lint-report
          path: lint-report.json
      
      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('lint-report.json', 'utf8'));
              const violations = report.filter(r => r.violations && r.violations.length > 0);
              
              if (violations.length > 0) {
                let comment = '## ⚠️ SQL Issues Found\n\n';
                violations.forEach(v => {
                  comment += `**File:** \`${v.path}\`\n`;
                });
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              } else {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: '✅ SQL formatting complete!'
                });
              }
            } catch (e) {
              console.log('Lint report parsing complete');
            }
